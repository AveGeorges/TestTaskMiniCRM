# Mini CRM - Распределение лидов между операторами

Сервис для автоматического распределения обращений лидов между операторами с учетом лимитов нагрузки и весового распределения по источникам.

## Технологический стек

- **Python** 3.8+
- **FastAPI** - веб-фреймворк
- **SQLAlchemy** - ORM для работы с БД
- **SQLite** - база данных (файл `crm.db`)
- **Pydantic** - валидация данных

## Установка и запуск

1. Создайте и активируйте виртуальное окружение:
```bash
python -m venv .venv
source .venv/bin/activate    # для Linux/MacOS
# или
.venv\Scripts\activate       # для Windows
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. (Опционально) Настройте переменные окружения:
```bash
# Скопируйте пример файла конфигурации
cp .env.example .env

# Отредактируйте .env при необходимости
# По умолчанию используется SQLite: sqlite:///./crm.db
```

4. Запустите приложение:
```bash
uvicorn app.main:app --reload
```

5. Откройте документацию API:
```
http://localhost:8000/docs
```

## Конфигурация

Приложение использует файл `.env` для настроек (опционально). Если файл отсутствует, используются значения по умолчанию.

### Переменные окружения

Создайте файл `.env` в корне проекта (можно скопировать из `.env.example`):

```env
# База данных
# Для SQLite: sqlite:///./crm.db
# Для PostgreSQL: postgresql://user:password@localhost/dbname
DATABASE_URL=sqlite:///./crm.db

# Настройки приложения
APP_NAME=Mini CRM - Распределение лидов
APP_VERSION=1.0.0
DEBUG=False

# Префикс API для версионирования
# Оставьте пустым для прямого доступа: /operators/, /sources/ и т.д.
# Или укажите префикс, например: /api/v1 (тогда эндпоинты будут: /api/v1/operators/, /api/v1/sources/)
API_V1_PREFIX=
```

**Примечание**: Файл `.env` уже добавлен в `.gitignore` и не будет попадать в репозиторий.

## Модель данных

### Сущности и связи

1. **Operator (Оператор)**
   - `id` - уникальный идентификатор
   - `name` - имя оператора
   - `is_active` - активен/не активен (может получать новые обращения)
   - `max_load` - лимит по максимальному количеству активных обращений
   - Связь: один оператор может обрабатывать множество обращений

2. **Source (Источник/Бот)**
   - `id` - уникальный идентификатор
   - `name` - название источника
   - Связь: один источник может иметь множество обращений

3. **SourceOperatorWeight (Вес оператора для источника)**
   - `id` - уникальный идентификатор
   - `source_id` - ссылка на источник
   - `operator_id` - ссылка на оператора
   - `weight` - числовой вес (компетенция/доля трафика)
   - Связь: многие-ко-многим между источниками и операторами с дополнительным полем веса

4. **Lead (Лид)**
   - `id` - уникальный идентификатор
   - `external_id` - внешний идентификатор (уникальный, используется для определения одного и того же лида)
   - `phone` - телефон (опционально)
   - `email` - email (опционально)
   - Связь: один лид может иметь множество обращений из разных источников

5. **Contact (Обращение/Контакт)**
   - `id` - уникальный идентификатор
   - `lead_id` - ссылка на лида
   - `source_id` - ссылка на источник
   - `operator_id` - ссылка на оператора (может быть `None`, если нет подходящих операторов)
   - `status` - статус обращения (active, closed и т.д.)
   - Связь: обращение связано с одним лидом, одним источником и одним оператором (или без оператора)

## Алгоритм распределения обращений

### 1. Определение лида

При создании нового обращения система:
- Ищет существующего лида по полю `external_id` (основной идентификатор)
- Если лид не найден, создает нового с переданными данными
- Это позволяет однозначно определить, что обращения относятся к одному и тому же лиду

### 2. Определение доступных операторов

Для источника система:
- Находит всех операторов, назначенных на данный источник через таблицу `SourceOperatorWeight`
- Фильтрует операторов по условиям:
  - Оператор активен (`is_active == True`)
  - Текущая нагрузка оператора меньше лимита (`current_load < max_load`)
  
**Нагрузка оператора** определяется как количество активных обращений (`status == "active"`), связанных с этим оператором.

### 3. Распределение с учетом весов

Для выбора оператора используется **вероятностный алгоритм**:
- Вычисляется сумма весов всех доступных операторов для данного источника
- Генерируется случайное число от 0 до суммы весов
- Оператор выбирается на основе кумулятивного распределения весов

**Пример**: 
- Оператор1 имеет вес 10 для источника A
- Оператор2 имеет вес 30 для источника A
- Вероятность выбора: Оператор1 ~25% (10/40), Оператор2 ~75% (30/40)

### 4. Создание обращения

Система создает обращение и связывает его с:
- Лидом (найденным или созданным)
- Источником
- Назначенным оператором (если он найден)

**Если подходящих операторов нет:**
- Обращение создается без оператора (`operator_id = None`)
- Это позволяет отслеживать обращения, которые не были распределены

## API Эндпоинты

### Операторы

- `POST /operators/` - создать оператора
- `GET /operators/` - получить список операторов
- `GET /operators/{operator_id}` - получить оператора по ID
- `PATCH /operators/{operator_id}` - обновить оператора (активность, лимит)
- `DELETE /operators/{operator_id}` - удалить оператора

### Источники

- `POST /sources/` - создать источник
- `GET /sources/` - получить список источников
- `GET /sources/{source_id}` - получить источник по ID
- `POST /sources/{source_id}/distribution` - настроить распределение (операторы и их веса)
- `GET /sources/{source_id}/distribution` - получить настройки распределения

### Обращения

- `POST /contacts/` - зарегистрировать обращение (автоматическое распределение)
- `GET /contacts/` - получить список обращений (с фильтрацией по lead_id, source_id, operator_id)
- `GET /contacts/{contact_id}` - получить обращение по ID

### Лиды

- `GET /leads/` - получить список лидов
- `GET /leads/{lead_id}` - получить лида по ID
- `GET /leads/{lead_id}/contacts` - получить все обращения конкретного лида

### Статистика

- `GET /stats/contacts` - статистика по обращениям (общее количество, по источникам, по операторам)
- `GET /stats/distribution` - статистика распределения по источникам и операторам

## Примеры использования

### 1. Создание операторов

```bash
POST /operators/
{
  "name": "Иван Иванов",
  "is_active": true,
  "max_load": 10
}
```

### 2. Создание источника

```bash
POST /sources/
{
  "name": "Telegram Bot 1"
}
```

### 3. Настройка распределения для источника

```bash
POST /sources/1/distribution
{
  "operator_weights": [
    {"operator_id": 1, "weight": 10},
    {"operator_id": 2, "weight": 30}
  ]
}
```

### 4. Регистрация обращения

```bash
POST /contacts/
{
  "external_id": "user_12345",
  "source_id": 1,
  "phone": "+79001234567",
  "email": "user@example.com"
}
```

Система автоматически:
- Найдет или создаст лида с `external_id = "user_12345"`
- Выберет оператора по правилам распределения
- Создаст обращение

## Структура проекта

```
TestTaskMiniCRM/
├── app/
│   ├── __init__.py
│   ├── main.py              # Точка входа FastAPI
│   ├── config.py            # Настройки приложения (загрузка из .env)
│   ├── database.py          # Настройка БД и сессий
│   ├── models.py            # SQLAlchemy модели
│   ├── schemas.py           # Pydantic схемы
│   ├── services.py          # Бизнес-логика распределения
│   └── routers/
│       ├── __init__.py
│       ├── operators.py     # CRUD операторов
│       ├── sources.py       # CRUD источников
│       ├── contacts.py      # Обращения
│       ├── leads.py         # Лиды
│       └── stats.py         # Статистика
├── .env.example             # Пример файла конфигурации
├── requirements.txt
├── README.md
└── crm.db                   # SQLite база данных (создается автоматически)
```

## Особенности реализации

- **Вероятностное распределение**: Используется случайный выбор с учетом весов для более естественного распределения трафика
- **Проверка лимитов**: Перед выбором оператора проверяется, не превышен ли его лимит нагрузки
- **Гибкость**: Обращения могут создаваться без оператора, если нет подходящих кандидатов
- **Идентификация лидов**: Использование `external_id` позволяет однозначно определить одного и того же лида

